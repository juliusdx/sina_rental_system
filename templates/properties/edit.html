{% extends "layout.html" %}

{% block dashboard_content %}
<header style="margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
    <a href="{{ url_for('properties.dashboard') }}" style="color: var(--text-muted); font-size: 1.5rem;"><i
            class='bx bx-arrow-back'></i></a>
    <div>
        <h1>Edit Property: {{ property.unit_number }}</h1>
        <div style="margin-top: 5px;">
            <span style="color: var(--text-muted);">Current Status: </span>
            <span
                class="{{ 'status-text-vacant' if property.status == 'vacant' else 'status-text-occupied' if property.status == 'occupied' else 'status-text-warning' }}">{{
                property.status.upper() }}</span>
        </div>
    </div>
</header>

<style>
    .status-text-vacant {
        color: #34d399;
    }

    .status-text-occupied {
        color: #f87171;
    }

    .status-text-warning {
        color: #fbbf24;
    }
</style>

{% with messages = get_flashed_messages() %}
{% if messages %}
{% for message in messages %}
<div class="alert alert-info">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}

{% if property.status == 'occupied' %}
<div class="alert"
    style="background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid #f87171; margin-bottom: 20px;">
    <i class='bx bx-error-circle'></i> <strong>Warning:</strong> This property is currently occupied.
    Changing the unit number might affect lease records.
</div>
{% endif %}

<form action="{{ url_for('properties.edit_property', id=property.id, **request.args.to_dict()) }}" method="POST"
    enctype="multipart/form-data" style="max-width: 800px;">
    <div class="glass-card" style="padding: 24px; margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
            <i class='bx bx-building-house'></i> Property Details
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Universal ID Builder -->
            <div
                style="grid-column: span 2; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border);">
                <label
                    style="color: var(--primary-color); font-weight: bold; margin-bottom: 15px; display: block;">Universal
                    Property ID</label>

                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <!-- Project -->
                    <div class="form-group" style="margin:0">
                        <label style="font-size: 0.8rem;">Project</label>
                        <div style="display: flex; gap: 5px;">
                            <select name="project_id" id="projectSelect" onchange="generateUniversalID()"
                                style="flex:1; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                                <option value="" style="color:black">-- Select --</option>
                                {% for p in projects %}
                                <option value="{{ p.id }}" data-name="{{ p.name }}" style="color:black" {% if
                                    property.project_id==p.id or property.project==p.name %}selected{% endif %}>{{
                                    p.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" onclick="openAddProjectModal()" class="btn"
                                style="padding: 0 10px; border: 1px solid var(--primary-color); background: rgba(59, 130, 246, 0.1); color: var(--primary-color);">+</button>
                        </div>
                    </div>

                    <!-- Block -->
                    <div class="form-group" style="margin:0">
                        <label style="font-size: 0.8rem;">Block</label>
                        <input type="text" name="block" id="inputBlock" value="{{ property.block or '' }}"
                            oninput="generateUniversalID()" placeholder="A, B..."
                            style="padding: 10px; border-radius: 8px; width: 100%;">
                    </div>

                    <!-- Floor -->
                    <div class="form-group" style="margin:0">
                        <label style="font-size: 0.8rem;">Floor</label>
                        <input type="text" name="floor" id="inputFloor" value="{{ property.floor or '' }}"
                            oninput="generateUniversalID()" placeholder="G, 1..."
                            style="padding: 10px; border-radius: 8px; width: 100%;">
                    </div>

                    <!-- Unit -->
                    <div class="form-group" style="margin:0">
                        <label style="font-size: 0.8rem;">Unit</label>
                        <input type="text" name="unit" id="inputUnit" value="{{ property.unit or '' }}"
                            oninput="generateUniversalID()" placeholder="01, 3A..."
                            style="padding: 10px; border-radius: 8px; width: 100%;">
                    </div>
                </div>

                <!-- Result -->
                <div class="form-group">
                    <label style="font-size: 0.8rem; color: var(--text-muted);">Generated Universal ID (Unique
                        Key)</label>
                    <input type="text" name="unit_number" id="universalID" required readonly
                        value="{{ property.unit_number }}"
                        style="background: rgba(0,0,0,0.3); color: #fbbf24; font-family: monospace; font-size: 1.1rem; letter-spacing: 1px; border-color: #fbbf24;">
                    <small style="color: var(--text-muted);">Auto-generated based on inputs above</small>
                </div>
            </div>

            <div class="form-group">
                <label>Category</label>
                <select name="property_category"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                    <option value="" style="color: black;">-- Select Category --</option>
                    <option value="Residential" style="color: black;" {% if property.property_category=='Residential'
                        %}selected{% endif %}>Residential</option>
                    <option value="Commercial" style="color: black;" {% if property.property_category=='Commercial'
                        %}selected{% endif %}>Commercial</option>
                    <option value="Industrial" style="color: black;" {% if property.property_category=='Industrial'
                        %}selected{% endif %}>Industrial</option>
                </select>
            </div>

            <div class="form-group">
                <label>Status</label>
                <select name="status"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                    <option value="vacant" style="color: black;" {% if property.status=='vacant' %}selected{% endif %}>
                        Vacant (Available)</option>
                    <option value="occupied" style="color: black;" disabled {% if property.status=='occupied'
                        %}selected{% endif %}>Occupied (Lease Active)</option>
                    <option value="maintenance" style="color: black;" {% if property.status=='maintenance' %}selected{%
                        endif %}>Maintenance</option>
                    <option value="reserved" style="color: black;" {% if property.status=='reserved' %}selected{% endif
                        %}>Reserved (Hold)</option>
                    <option value="Reserved by DL" style="color: black;" {% if property.status=='Reserved by DL'
                        %}selected{% endif %}>Reserved by DL</option>
                    <option value="sold" style="color: black;" {% if property.status=='sold' %}selected{% endif %}>Sold
                    </option>
                </select>
                {% if property.status == 'occupied' %}
                <small style="color: var(--text-muted); font-size: 0.8rem; display: block; margin-top: 5px;">
                    <i class='bx bx-info-circle'></i> Status is managed by active leases.
                </small>
                {% endif %}
            </div>

            <div class="form-group">
                <label>Property Type</label>
                <select name="property_type" id="propertyTypeSelect" onchange="toggleFurnishing()"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                    <option value="" style="color: black;">-- Select --</option>
                    <option value="Shop" style="color: black;" {% if property.property_type=='Shop' %}selected{% endif
                        %}>Shop</option>
                    <option value="Office" style="color: black;" {% if property.property_type=='Office' %}selected{%
                        endif %}>Office</option>
                    <option value="Apartment" style="color: black;" {% if property.property_type=='Apartment'
                        %}selected{% endif %}>Apartment</option>
                    <option value="Condo" style="color: black;" {% if property.property_type=='Condo' %}selected{% endif
                        %}>Condo</option>
                    <option value="Warehouse" style="color: black;" {% if property.property_type=='Warehouse'
                        %}selected{% endif %}>Warehouse</option>
                    <option value="Stall" style="color: black;" {% if property.property_type=='Stall' %}selected{% endif
                        %}>Stall</option>
                    <option value="Other" style="color: black;" {% if property.property_type=='Other' %}selected{% endif
                        %}>Other</option>
                    <option value="Terrace" style="color: black;" {% if property.property_type=='Terrace' %}selected{%
                        endif %}>Terrace</option>
                    <option value="Acc. Parcel" style="color: black;" {% if property.property_type=='Acc. Parcel'
                        %}selected{% endif %}>Acc. Parcel</option>
                    <option value="Land" style="color: black;" {% if property.property_type=='Land' %}selected{% endif
                        %}>Land</option>
                    <option value="Drive-thru" style="color: black;" {% if property.property_type=='Drive-thru'
                        %}selected{% endif %}>Drive-thru</option>
                </select>
            </div>



            <div class="form-group">
                <label>Unit Position</label>
                <select name="unit_position"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                    <option value="" style="color: black;">-- Select Position --</option>
                    <option value="Intermediate" style="color: black;" {% if property.unit_position=='Intermediate'
                        %}selected{% endif %}>Intermediate</option>
                    <option value="Corner" style="color: black;" {% if property.unit_position=='Corner' %}selected{%
                        endif %}>Corner</option>
                    <option value="End Lot" style="color: black;" {% if property.unit_position=='End Lot' %}selected{%
                        endif %}>End Lot</option>
                </select>
            </div>

            <div class="form-group" id="furnishingField" style="display: none;">
                <label>Furnishing Status</label>
                <select name="furnishing_status"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                    <option value="" style="color: black;">-- Select Status --</option>
                    <option value="Unfurnished" style="color: black;" {% if property.furnishing_status=='Unfurnished'
                        %}selected{% endif %}>Unfurnished</option>
                    <option value="Partially Furnished" style="color: black;" {% if
                        property.furnishing_status=='Partially Furnished' %}selected{% endif %}>Partially Furnished
                    </option>
                    <option value="Fully Furnished" style="color: black;" {% if
                        property.furnishing_status=='Fully Furnished' %}selected{% endif %}>Fully Furnished</option>
                </select>
            </div>

            <div class="form-group">
                <label>Size (sq ft) [Build Up]</label>
                <input type="number" step="0.01" name="size_sqft" value="{{ property.size_sqft or '' }}">
            </div>

            <div class="form-group">
                <label>Land Area (sq ft)</label>
                <input type="number" step="0.01" name="land_size" value="{{ property.land_size or '' }}"
                    placeholder="For Terrace/Land properties">
            </div>

            <div class="form-group">
                <label>Target Rent (RM)</label>
                <input type="number" step="0.01" name="target_rent" value="{{ property.target_rent or '' }}">
            </div>

            <div class="form-group">
                <label>Bedrooms</label>
                <input type="number" name="bedrooms" value="{{ property.bedrooms or 0 }}">
            </div>

            <div class="form-group">
                <label>Bathrooms</label>
                <input type="number" name="bathrooms" value="{{ property.bathrooms or 0 }}">
            </div>

            <div class="form-group" style="grid-column: span 2;">
                <label>Property Photo</label>
                {% if property.image_path %}
                <div style="margin-bottom: 10px;">
                    <img src="{{ url_for('static', filename=property.image_path) }}"
                        style="max-height: 200px; border-radius: 8px;">
                </div>
                {% endif %}
                <input type="file" name="image" accept="image/*"
                    style="padding: 10px; border: 1px solid var(--glass-border); border-radius: 8px; width: 100%;">
            </div>

            <div class="form-group" style="grid-column: span 2;">
                <label>Description (Public/Marketing)</label>
                <textarea name="description" rows="3"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;"
                    placeholder="Marketing description for listings...">{{ property.description or '' }}</textarea>
            </div>

            <div class="form-group" style="grid-column: span 2;">
                <label>Notes (Internal)</label>
                <textarea name="notes" rows="3"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">{{ property.notes or '' }}</textarea>
            </div>
        </div>
    </div>

    <div class="glass-card" style="padding: 24px; margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
            <i class='bx bx-dollar-circle'></i> Expected Charges (Budget)
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label>Annual Quit Rent (RM)</label>
                <input type="number" step="0.01" name="expected_quit_rent"
                    value="{{ property.expected_quit_rent or '' }}" placeholder="0.00"
                    style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Annual Assessment (RM)</label>
                <input type="number" step="0.01" name="expected_assessment"
                    value="{{ property.expected_assessment or '' }}" placeholder="0.00"
                    style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Annual Fire Insurance (RM)</label>
                <input type="number" step="0.01" name="expected_fire_insurance"
                    value="{{ property.expected_fire_insurance or '' }}" placeholder="0.00"
                    style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Monthly Management Fee (RM)</label>
                <input type="number" step="0.01" name="expected_management_fee"
                    value="{{ property.expected_management_fee or '' }}" placeholder="0.00"
                    style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Monthly Sinking Fund (RM)</label>
                <input type="number" step="0.01" name="expected_sinking_fund"
                    value="{{ property.expected_sinking_fund or '' }}" placeholder="0.00"
                    style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
            <div class="form-group">
                <label>Monthly Water Bill (If Fixed) (RM)</label>
                <input type="number" step="0.01" name="expected_water" value="{{ property.expected_water or '' }}"
                    placeholder="0.00" style="padding: 10px; border-radius: 8px; width: 100%;">
            </div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        {% if property.status == 'vacant' and not property.archived %}
        <button type="button" id="archiveBtn" class="btn" data-id="{{ property.id }}"
            style="background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid #f87171;">
            <i class='bx bx-archive'></i> Archive Property
        </button>
        {% else %}
        <div></div>
        {% endif %}

        <div style="display: flex; gap: 15px;">
            <a href="{{ url_for('properties.history', id=property.id) }}" class="btn"
                style="background: transparent; border: 1px solid var(--primary); color: var(--primary);">
                <i class='bx bx-history'></i> History
            </a>
            <a href="{{ url_for('properties.dashboard') }}" class="btn"
                style="background: transparent; border: 1px solid var(--text-muted);">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </div>
</form>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
    <div class="modal-content glass-card"
        style="margin: 15% auto; padding: 30px; border: 1px solid var(--glass-border); width: 400px; max-width: 90%;">
        <h3>Add New Project</h3>
        <input type="text" id="newProjectName" placeholder="Project Name"
            style="width: 100%; margin: 20px 0; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">

        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closeAddProjectModal()" class="btn"
                style="background: transparent; border: 1px solid var(--text-muted);">Cancel</button>
            <button onclick="saveNewProject()" class="btn btn-primary">Save</button>
        </div>
    </div>
</div>

<script>
    // alert("DEBUG: Script Loaded!"); // Uncomment to test if script runs
    console.log("Edit Property Script Loaded.");

    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM Content Loaded.");
        toggleFurnishing();

        // Archive Button Logic
        const archiveBtn = document.getElementById('archiveBtn');
        if (archiveBtn) {
            console.log("Archive Button Found. Attaching listener.");
            archiveBtn.addEventListener('click', function (e) {
                e.preventDefault(); // Just in case, though type=button
                console.log("Archive Button CLICKED (Event Listener)");
                const id = this.getAttribute('data-id');
                triggerArchive(id);
            });
        } else {
            console.log("Archive Button NOT found (maybe property is not vacant/already archived).");
        }
    });

    function toggleFurnishing() {
        const typeSelect = document.getElementById('propertyTypeSelect');
        if (!typeSelect) return;

        const type = typeSelect.value;
        const field = document.getElementById('furnishingField');
        const RESIDENTIAL = ['Apartment', 'Condo', 'House', 'Residential'];

        if (RESIDENTIAL.includes(type)) {
            field.style.display = 'block';
        } else {
            field.style.display = 'none';
        }
    }

    async function triggerArchive(id) {
        console.log("Archive button clicked for ID:", id);
        // Temporary alert to prove the button works (User requested visual confirmation)
        // alert("Archive sequence started for ID: " + id); 

        if (!confirm('Are you sure you want to archive this property?\nIt will be hidden from the main inventory list.')) {
            console.log("Archive cancelled by user.");
            return;
        }

        try {
            const url = '/properties/archive/' + id;
            console.log("Sending POST request to:", url);

            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log("Response status:", res.status);

            if (!res.ok) {
                const text = await res.text();
                console.error("Server error response:", text);
                throw new Error('Network response check failed: ' + res.status);
            }

            const data = await res.json();
            console.log("Response data:", data);

            if (data.status === 'success') {
                alert(data.message);
                window.location.href = "{{ url_for('properties.dashboard') }}";
            } else {
                alert(data.message || 'Error archiving property');
            }
        } catch (e) {
            console.error("Archive Exception:", e);
            alert('An error occurred: ' + e.message);
        }
    }

    function openAddProjectModal() {
        document.getElementById('addProjectModal').style.display = 'block';
    }

    function closeAddProjectModal() {
        document.getElementById('addProjectModal').style.display = 'none';
        document.getElementById('newProjectName').value = '';
    }

    async function saveNewProject() {
        const name = document.getElementById('newProjectName').value;
        if (!name) return;

        try {
            const formData = new FormData();
            formData.append('name', name);

            const res = await fetch("{{ url_for('properties.add_project') }}", {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.status === 'success') {
                // Add to dropdown and select it
                const select = document.getElementById('projectSelect');
                const opt = document.createElement('option');
                opt.value = data.id;
                opt.text = data.name;
                opt.style.color = "black";
                select.add(opt);
                select.value = data.id;

                closeAddProjectModal();
            } else {
                alert(data.message);
            }
        } catch (e) {
            console.error(e);
            alert('Error adding project');
        }
    }
    function generateUniversalID() {
        // Get values
        const projectSelect = document.getElementById('projectSelect');
        const project = projectSelect.options[projectSelect.selectedIndex]?.getAttribute('data-name') || '';
        const block = document.getElementById('inputBlock').value.trim();
        const floor = document.getElementById('inputFloor').value.trim();
        const unit = document.getElementById('inputUnit').value.trim();

        // Build parts array (filtering empty)
        let parts = [project, block, floor, unit].filter(p => p !== '');

        // Join with dash
        const finalID = parts.join('-');

        // Update Readonly Input
        document.getElementById('universalID').value = finalID;
    }
</script>
{% endblock %}