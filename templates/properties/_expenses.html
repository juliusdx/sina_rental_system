<section>
    <div
        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="color: var(--text-main); margin: 0;">
            <i class='bx bx-money'></i> Expenses
        </h2>
        <button onclick="document.getElementById('addExpenseModal').style.display='flex'" class="btn btn-primary">
            <i class='bx bx-plus'></i> Add Expense
        </button>
    </div>

    <!-- Stats Row -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
        <div class="glass-card" style="padding: 15px; text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-muted);">Total Expenses</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--text-main);">
                RM {{ "%.2f"|format(expense_stats.total) }}
            </div>
        </div>
        <div class="glass-card" style="padding: 15px; text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-muted);">Paid by Us</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">
                RM {{ "%.2f"|format(expense_stats.paid) }}
            </div>
        </div>
        <div class="glass-card" style="padding: 15px; text-align: center;">
            <div style="font-size: 0.8rem; color: var(--text-muted);">Pending</div>
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--error);">
                RM {{ "%.2f"|format(expense_stats.pending) }}
            </div>
        </div>
    </div>

    {% if not expenses %}
    <p style="color: var(--text-muted); font-style: italic;">No expenses recorded.</p>
    {% else %}
    <div class="glass-card" style="padding: 0; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead>
                <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                    <th style="padding: 12px; color: var(--text-muted);">Date</th>
                    <th style="padding: 12px; color: var(--text-muted);">Type</th>
                    <th style="padding: 12px; color: var(--text-muted);">Amount</th>
                    <th style="padding: 12px; color: var(--text-muted);">Status</th>
                    <th style="padding: 12px; color: var(--text-muted); text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in expenses %}
                <tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 12px;">{{ exp.bill_date.strftime('%d %b %Y') }}</td>
                    <td style="padding: 12px;">
                        <span style="display: block; font-weight: 500;">{{ exp.expense_type|replace('_', ' ')|title
                            }}</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">{{ exp.description or '' }}</span>
                    </td>
                    <td style="padding: 12px;">RM {{ "%.2f"|format(exp.amount) }}</td>
                    <td style="padding: 12px;">
                        {% if exp.paid_by_company %}
                        <span style="color: var(--success); font-size: 0.8rem;">
                            <i class='bx bx-check'></i> Paid ({{ exp.payment_date.strftime('%d/%m') }})
                        </span>
                        {% else %}
                        <span style="color: var(--error); font-size: 0.8rem;">
                            Unpaid
                        </span>
                        {% endif %}

                        <!-- Export Status -->
                        {% if exp.export_status == 'exported' %}
                        <span title="Exported to Accounting" style="margin-left:5px; color: var(--primary);">
                            <i class='bx bx-export'></i>
                        </span>
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: right;">
                        {% if not exp.paid_by_company %}
                        <form action="{{ url_for('properties.mark_expense_paid', id=exp.id) }}" method="POST"
                            style="display: inline;">
                            <input type="hidden" name="payment_date" value="{{ today }}">
                            <button type="submit" class="btn btn-xs" title="Mark Paid" style="color: var(--success);">
                                <i class='bx bx-check-circle'></i>
                            </button>
                        </form>
                        {% endif %}
                        <form action="{{ url_for('properties.delete_expense', id=exp.id) }}" method="POST"
                            style="display: inline;" onsubmit="return confirm('Delete this expense?');">
                            <button type="submit" class="btn btn-xs" style="color: var(--text-muted);">
                                <i class='bx bx-trash'></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</section>

<!-- Add Expense Modal -->
<div id="addExpenseModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 500px; max-width: 90%; background: var(--background-dark);">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Add Expense</h3>
            <button type="button" onclick="document.getElementById('addExpenseModal').style.display='none'"
                style="background: none; border: none; color: white; cursor: pointer;">
                <i class='bx bx-x' style="font-size: 1.5rem;"></i>
            </button>
        </header>

        <form action="{{ url_for('properties.add_expense', id=property.id) }}" method="POST">
            <div style="margin-bottom: 15px;">
                <label>Type</label>
                <select name="expense_type" class="form-control" required
                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 6px;">
                    <option value="quit_rent" style="background: #333; color: white;">Quit Rent</option>
                    <option value="assessment" style="background: #333; color: white;">Assessment (Cukai Pintu)</option>
                    <option value="fire_insurance" style="background: #333; color: white;">Fire Insurance</option>
                    <option value="management_fee" style="background: #333; color: white;">Management Fee</option>
                    <option value="sinking_fund" style="background: #333; color: white;">Sinking Fund</option>
                    <option value="water" style="background: #333; color: white;">Water Charges</option>
                    <option value="repair" style="background: #333; color: white;">Repair/Maintenance</option>
                    <option value="other" style="background: #333; color: white;">Other</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label>Amount (RM)</label>
                    <input type="number" step="0.01" name="amount" required class="form-control"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 6px;">
                </div>
                <div>
                    <label>Bill Date</label>
                    <input type="date" name="bill_date" required class="form-control"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 6px;">
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label>Description (Optional/Vendor)</label>
                <input type="text" name="description" placeholder="e.g. MBPJ Invoice #123" class="form-control"
                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" name="charge_tenant" style="width: 20px; height: 20px;">
                    <span style="color: var(--text-main);">Charge back to Tenant?</span>
                </label>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin: 5px 0 0 30px;">
                    If checked, this amount will be added to the tenant's next invoice.
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <label>GL Code (Optional)</label>
                <input type="text" name="gl_code" placeholder="Keypoint Account Code" class="form-control"
                    style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 6px;">
            </div>

            <div style="text-align: right;">
                <button type="button" onclick="document.getElementById('addExpenseModal').style.display='none'"
                    class="btn" style="margin-right: 10px;">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Expense</button>
            </div>
        </form>
    </div>
</div>