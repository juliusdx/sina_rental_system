{% extends "layout.html" %}

{% block dashboard_content %}
<header style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1><i class='bx bx-receipt'></i> Property Expenses</h1>
        <p style="color: var(--text-muted);">Manage and track all property-related expenses</p>
    </div>
    <button onclick="document.getElementById('bulkExpenseModal').style.display='flex'" class="btn btn-primary">
        <i class='bx bx-plus-circle'></i> Add Expenses (Bulk)
    </button>
</header>

<!-- Stats Row -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
    <div class="glass-card" style="padding: 20px; text-align: center;">
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Total Expenses</div>
        <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-main);">
            RM {{ "%.2f"|format(stats.total) }}
        </div>
    </div>
    <div class="glass-card" style="padding: 20px; text-align: center;">
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Paid</div>
        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">
            RM {{ "%.2f"|format(stats.paid) }}
        </div>
    </div>
    <div class="glass-card" style="padding: 20px; text-align: center;">
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Pending</div>
        <div style="font-size: 1.5rem; font-weight: bold; color: var(--error);">
            RM {{ "%.2f"|format(stats.pending) }}
        </div>
    </div>
    <div class="glass-card" style="padding: 20px; text-align: center;">
        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Total Items</div>
        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
            {{ stats.count }}
        </div>
    </div>
</div>

<!-- Filters -->
<div style="margin-bottom: 20px;">
    <form method="GET" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select name="property" onchange="this.form.submit()"
            style="padding: 8px; background: var(--bg-card); color: white; border: 1px solid var(--glass-border); border-radius: 6px;">
            <option value="" style="background: #333; color: white;">All Properties</option>
            {% for prop in properties %}
            <option value="{{ prop.id }}" {% if current_filters.property==prop.id|string %}selected{% endif %}
                style="background: #333; color: white;">
                {{ prop.unit_number }}
            </option>
            {% endfor %}
        </select>

        <select name="expense_type" onchange="this.form.submit()"
            style="padding: 8px; background: var(--bg-card); color: white; border: 1px solid var(--glass-border); border-radius: 6px;">
            <option value="" style="background: #333; color: white;">All Types</option>
            <option value="quit_rent" {% if current_filters.expense_type=='quit_rent' %}selected{% endif %}
                style="background: #333; color: white;">Quit Rent
            </option>
            <option value="assessment" {% if current_filters.expense_type=='assessment' %}selected{% endif %}
                style="background: #333; color: white;">Assessment
            </option>
            <option value="fire_insurance" {% if current_filters.expense_type=='fire_insurance' %}selected{% endif %}
                style="background: #333; color: white;">
                Fire Insurance</option>
            <option value="management_fee" {% if current_filters.expense_type=='management_fee' %}selected{% endif %}
                style="background: #333; color: white;">
                Management Fee</option>
            <option value="sinking_fund" {% if current_filters.expense_type=='sinking_fund' %}selected{% endif %}
                style="background: #333; color: white;">
                Sinking Fund</option>
            <option value="water" {% if current_filters.expense_type=='water' %}selected{% endif %}
                style="background: #333; color: white;">Water</option>
            <option value="repair" {% if current_filters.expense_type=='repair' %}selected{% endif %}
                style="background: #333; color: white;">Repair</option>
            <option value="other" {% if current_filters.expense_type=='other' %}selected{% endif %}
                style="background: #333; color: white;">Other</option>
        </select>

        <select name="status" onchange="this.form.submit()"
            style="padding: 8px; background: var(--bg-card); color: white; border: 1px solid var(--glass-border); border-radius: 6px;">
            <option value="" style="background: #333; color: white;">All Status</option>
            <option value="paid" {% if current_filters.status=='paid' %}selected{% endif %}
                style="background: #333; color: white;">Paid</option>
            <option value="unpaid" {% if current_filters.status=='unpaid' %}selected{% endif %}
                style="background: #333; color: white;">Unpaid</option>
        </select>

        <select name="export_status" onchange="this.form.submit()"
            style="padding: 8px; background: var(--bg-card); color: white; border: 1px solid var(--glass-border); border-radius: 6px;">
            <option value="all" style="background: #333; color: white;">All Export Status</option>
            <option value="pending" {% if current_filters.export_status=='pending' %}selected{% endif %}
                style="background: #333; color: white;">Pending Export</option>
            <option value="exported" {% if current_filters.export_status=='exported' %}selected{% endif %}
                style="background: #333; color: white;">Exported</option>
        </select>

        <a href="{{ url_for('properties.export_expenses', property=current_filters.property, expense_type=current_filters.expense_type, status=current_filters.status, export_status=current_filters.export_status) }}"
            class="btn btn-primary" style="margin-left: auto;">
            <i class='bx bx-download'></i> Export to Excel
        </a>
    </form>
</div>

<!-- Expenses Table -->
{% if expenses %}
<div class="glass-card" style="padding: 0; overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                <th style="padding: 15px; color: var(--text-muted);">Property</th>
                <th style="padding: 15px; color: var(--text-muted);">Date</th>
                <th style="padding: 15px; color: var(--text-muted);">Type</th>
                <th style="padding: 15px; color: var(--text-muted);">Description</th>
                <th style="padding: 15px; color: var(--text-muted);">Amount</th>
                <th style="padding: 15px; color: var(--text-muted);">Status</th>
                <th style="padding: 15px; color: var(--text-muted);">Exported</th>
                <th style="padding: 15px; color: var(--text-muted);">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses %}
            <tr style="border-bottom: 1px solid var(--glass-border);">
                <td style="padding: 15px;">
                    <a href="{{ url_for('properties.history', id=exp.property_id) }}"
                        style="color: var(--primary); text-decoration: none;">
                        {{ exp.property.unit_number }}
                    </a>
                </td>
                <td style="padding: 15px;">{{ exp.bill_date.strftime('%d %b %Y') }}</td>
                <td style="padding: 15px;">{{ exp.expense_type|replace('_', ' ')|title }}</td>
                <td style="padding: 15px; color: var(--text-muted); font-size: 0.9rem;">{{ exp.description or '-' }}
                </td>
                <td style="padding: 15px; font-weight: bold;">RM {{ "%.2f"|format(exp.amount) }}</td>
                <td style="padding: 15px;">
                    {% if exp.paid_by_company %}
                    <span
                        style="color: var(--success); font-size: 0.85rem; background: rgba(16, 185, 129, 0.2); padding: 4px 8px; border-radius: 4px;">
                        <i class='bx bx-check'></i> Paid
                    </span>
                    {% else %}
                    <span
                        style="color: var(--error); font-size: 0.85rem; background: rgba(239, 68, 68, 0.2); padding: 4px 8px; border-radius: 4px;">
                        Unpaid
                    </span>
                    {% endif %}
                </td>
                <td style="padding: 15px; text-align: center;">
                    {% if exp.export_status == 'exported' %}
                    <span
                        title="Exported on {{ exp.exported_at.strftime('%Y-%m-%d %H:%M') if exp.exported_at else '' }}"
                        style="color: var(--text-muted); font-size: 1.2rem;">
                        <i class='bx bx-export'></i>
                    </span>
                    {% else %}
                    <span title="Pending Export" style="color: var(--warning); font-size: 1.2rem;">
                        <i class='bx bx-time'></i>
                    </span>
                    {% endif %}
                </td>
                <td style="padding: 15px;">
                    {% if not exp.paid_by_company %}
                    <form action="{{ url_for('properties.mark_expense_paid', id=exp.id) }}" method="POST"
                        style="display: inline;">
                        <input type="hidden" name="payment_date" value="{{ today }}">
                        <button type="submit" class="btn btn-xs" title="Mark Paid" style="color: var(--success);">
                            <i class='bx bx-check-circle'></i>
                        </button>
                    </form>
                    {% endif %}
                    <form action="{{ url_for('properties.delete_expense', id=exp.id) }}" method="POST"
                        style="display: inline;" onsubmit="return confirm('Delete?');">
                        <button type="submit" class="btn btn-xs" style="color: var(--text-muted);">
                            <i class='bx bx-trash'></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="glass-card" style="padding: 40px; text-align: center;">
    <i class='bx bx-receipt' style="font-size: 3rem; color: var(--text-muted); margin-bottom: 10px;"></i>
    <p style="color: var(--text-muted);">No expenses found. Click "Add Expenses (Bulk)" to get started.</p>
</div>
{% endif %}

<!-- Bulk Add Expense Modal -->
<div id="bulkExpenseModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
    <div class="glass-card" style="width: 95%; max-width: 1400px; background: var(--background-dark); margin: 20px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h3><i class='bx bx-plus-circle'></i> Quick Expense Entry</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin: 5px 0 0 0;">Select property and date,
                    then fill in the relevant expense amounts. Only completed rows will be saved.</p>
            </div>
            <button type="button" onclick="document.getElementById('bulkExpenseModal').style.display='none'"
                style="background: none; border: none; color: white; cursor: pointer;">
                <i class='bx bx-x' style="font-size: 1.5rem;"></i>
            </button>
        </header>

        <div style="overflow-x: auto; margin-bottom: 20px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05);">
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 150px;">
                            Property</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">Bill
                            Date</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">Quit
                            Rent</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">
                            Assessment</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">Fire
                            Ins.</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">Mgmt
                            Fee</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 120px;">Sinking
                            Fund</th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 100px;">Water
                        </th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 100px;">Repair
                        </th>
                        <th style="padding: 10px; text-align: left; color: var(--text-muted); min-width: 100px;">Other
                        </th>
                        <th style="padding: 10px; text-align: center; color: var(--text-muted); min-width: 80px;">Action
                        </th>
                    </tr>
                </thead>
                <tbody id="expenseRows">
                    {% for i in range(5) %}
                    <tr style="border-bottom: 1px solid var(--glass-border);">
                        <td style="padding: 10px;">
                            <select name="property_{{ i }}" class="form-control"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                                <option value="" style="background: #333; color: white;">Select Property</option>
                                {% for prop in properties %}
                                <option value="{{ prop.id }}" style="background: #333; color: white;">{{
                                    prop.unit_number }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td style="padding: 10px;">
                            <input type="date" name="date_{{ i }}"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="quit_rent_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_quit_rent_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="assessment_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_assessment_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="fire_insurance_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_fire_insurance_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="management_fee_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_management_fee_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="sinking_fund_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_sinking_fund_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="water_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_water_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="repair_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_repair_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px;">
                            <input type="number" step="0.01" name="other_{{ i }}" placeholder="0.00"
                                style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; border-radius: 4px;">
                            <label
                                style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <input type="checkbox" name="charge_other_{{ i }}" style="margin: 0;"> Charge
                            </label>
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <button type="button" onclick="saveExpenseRow({{ i }})" class="btn btn-primary btn-sm"
                                style="padding: 8px 15px; font-size: 0.85rem;">
                                <i class='bx bx-save'></i> Save
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="text-align: right; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <button type="button" onclick="document.getElementById('bulkExpenseModal').style.display='none'"
                class="btn">
                <i class='bx bx-x'></i> Close
            </button>
        </div>
    </div>
</div>

<script>
    async function saveExpenseRow(rowIndex) {
        const property = document.querySelector(`[name="property_${rowIndex}"]`).value;
        const date = document.querySelector(`[name="date_${rowIndex}"]`).value;

        if (!property || !date) {
            alert('Please select a property and date for this row.');
            return;
        }

        // Collect expense amounts
        const expenses = {
            'quit_rent': document.querySelector(`[name="quit_rent_${rowIndex}"]`).value,
            'assessment': document.querySelector(`[name="assessment_${rowIndex}"]`).value,
            'fire_insurance': document.querySelector(`[name="fire_insurance_${rowIndex}"]`).value,
            'management_fee': document.querySelector(`[name="management_fee_${rowIndex}"]`).value,
            'sinking_fund': document.querySelector(`[name="sinking_fund_${rowIndex}"]`).value,
            'water': document.querySelector(`[name="water_${rowIndex}"]`).value,
            'repair': document.querySelector(`[name="repair_${rowIndex}"]`).value,
            'other': document.querySelector(`[name="other_${rowIndex}"]`).value
        };

        // Filter out empty amounts
        const filledExpenses = Object.entries(expenses).filter(([type, amount]) => amount && parseFloat(amount) > 0);

        if (filledExpenses.length === 0) {
            alert('Please enter at least one expense amount.');
            return;
        }

        // Send to backend
        try {
            const formData = new FormData();
            formData.append('property_id', property);
            formData.append('bill_date', date);

            filledExpenses.forEach(([type, amount]) => {
                const chargeCheckbox = document.querySelector(`[name="charge_${type}_${rowIndex}"]`);
                const chargeTenant = chargeCheckbox ? chargeCheckbox.checked : false;

                formData.append('expenses[]', JSON.stringify({
                    type: type,
                    amount: amount,
                    charge_tenant: chargeTenant
                }));
            });

            const response = await fetch('{{ url_for("properties.add_expense_row") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.status === 'success') {
                alert(`âœ“ Saved ${data.count} expense(s) for this property.`);
                // Clear the row
                document.querySelector(`[name="property_${rowIndex}"]`).value = '';
                document.querySelector(`[name="date_${rowIndex}"]`).value = '';
                Object.keys(expenses).forEach(type => {
                    document.querySelector(`[name="${type}_${rowIndex}"]`).value = '';
                });
                // Reload page to update stats
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error(error);
            alert('Error saving expenses. Please try again.');
        }
    }
</script>

{% endblock %}