{% extends "layout.html" %}

{% block dashboard_content %}
<header style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>Property Inventory</h1>
        <p style="color: var(--text-muted);">View status of all units.</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('properties.bulk_upload') }}" class="btn"
            style="background: transparent; border: 1px solid var(--text-muted); color: var(--text-main);">
            <i class='bx bx-cloud-upload'></i> Bulk Upload
        </a>
        <a href="{{ url_for('properties.add_property') }}" class="btn btn-primary">
            <i class='bx bx-plus'></i> Add Property
        </a>
    </div>
</header>

<!-- Stats -->
<div class="stats-grid">
    <a href="{{ url_for('properties.dashboard', status='vacant') }}" style="text-decoration: none; color: inherit;">
        <div class="glass-card stat-card" style="cursor: pointer; transition: transform 0.2s;">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #34d399;">
                <i class='bx bx-check-circle'></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.vacancy }}</h3>
                <p>Vacant Units</p>
            </div>
        </div>
    </a>
    <a href="{{ url_for('properties.dashboard', status='occupied') }}" style="text-decoration: none; color: inherit;">
        <div class="glass-card stat-card" style="cursor: pointer; transition: transform 0.2s;">
            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: #f87171;">
                <i class='bx bx-user'></i>
            </div>
            <div class="stat-info">
                <h3>{{ stats.occupancy }}</h3>
                <p>Occupied Units</p>
            </div>
        </div>
    </a>
    <div class="glass-card stat-card">
        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #60a5fa;">
            <i class='bx bx-chart'></i>
        </div>
        <div class="stat-info">
            <h3>{{ "%.1f"|format(stats.rate) }}%</h3>
            <p>Occupancy Rate</p>
        </div>
    </div>
</div>

<style>
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    /* Filter Pills */
    .filter-pill {
        border: none;
        padding: 4px 12px;
        border-radius: 6px;
        cursor: pointer;
        background: transparent;
        color: var(--text-muted);
    }

    .filter-pill.active {
        background: var(--primary);
        color: #000;
    }

    .filter-pill.active-vacant {
        background: var(--success);
        color: #000;
    }

    .filter-pill.active-occupied {
        background: var(--error);
        color: #000;
    }

    /* Toggle Button */
    .toggle-btn {
        background: transparent;
        border: 1px solid var(--glass-border);
        padding: 8px 12px;
        border-radius: 6px;
        color: var(--text-main);
        cursor: pointer;
    }

    .toggle-btn.active {
        background: var(--primary);
        color: #000;
    }

    /* Property Card Borders */
    .border-status-archived {
        border-left: 4px solid #888;
    }

    .border-status-occupied {
        border-left: 4px solid #f87171;
    }

    .border-status-vacant {
        border-left: 4px solid #34d399;
    }

    .border-status-sold {
        border-left: 4px solid #ef4444;
        /* Red for Sold */
    }

    /* Status Pills */
    .pill-status {
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 12px;
        text-transform: uppercase;
        font-weight: bold;
    }

    .pill-status-archived {
        background: rgba(128, 128, 128, 0.2);
        color: #888;
    }

    .pill-status-occupied {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    .pill-status-vacant {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
    }

    .pill-status-sold {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    /* High Contrast Filters */
    .filter-select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #64748b !important;
        background: #1e293b !important;
        /* Solid Dark Slate */
        color: #f8fafc !important;
        /* Bright White */
        cursor: pointer;
        font-weight: 500;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .filter-select option {
        background: #0f172a;
        /* Even darker for dropdown */
        color: #ffffff;
        padding: 8px;
    }

    .filter-select:focus {
        border-color: var(--primary) !important;
        outline: none;
        box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.2);
    }
</style>

<!-- Filters -->
<div style="margin-bottom: 20px;">
    <form id="filterForm" action="{{ url_for('properties.dashboard') }}" method="GET"
        style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-end;">

        <!-- Filter: Status (disabled - use pills below instead) -->
        <select class="form-select filter-select" onchange="document.getElementById('filterForm').submit()"
            style="width: 140px; display: none;">
            <option value="">All Statuses</option>
            <option value="vacant" {% if request.args.get('status')=='vacant' %}selected{% endif %}>Vacant</option>
            <option value="occupied" {% if request.args.get('status')=='occupied' %}selected{% endif %}>Occupied
            </option>
            <option value="reserved" {% if request.args.get('status')=='reserved' %}selected{% endif %}>Reserved
            </option>
            <option value="maintenance" {% if request.args.get('status')=='maintenance' %}selected{% endif %}>
                Maintenance</option>
            <option value="sold" {% if request.args.get('status')=='sold' %}selected{% endif %}>Sold</option>
        </select>

        <!-- Filter: Type -->
        <select name="type" class="form-select filter-select" onchange="document.getElementById('filterForm').submit()"
            style="width: 140px;">
            <option value="">All Types</option>
            <option value="Apartment" {% if request.args.get('type')=='Apartment' %}selected{% endif %}>Apartment
            </option>
            <option value="Condo" {% if request.args.get('type')=='Condo' %}selected{% endif %}>Condo</option>
            <option value="Shop" {% if request.args.get('type')=='Shop' %}selected{% endif %}>Shop</option>
            <option value="Office" {% if request.args.get('type')=='Office' %}selected{% endif %}>Office</option>
            <option value="Terrace" {% if request.args.get('type')=='Terrace' %}selected{% endif %}>Terrace</option>
            <option value="Warehouse" {% if request.args.get('type')=='Warehouse' %}selected{% endif %}>Warehouse
            </option>
            <option value="Stall" {% if request.args.get('type')=='Stall' %}selected{% endif %}>Stall</option>
            <option value="Acc. Parcel" {% if request.args.get('type')=='Acc. Parcel' %}selected{% endif %}>Acc. Parcel
            </option>
            <option value="Land" {% if request.args.get('type')=='Land' %}selected{% endif %}>Land</option>
            <option value="Drive-thru" {% if request.args.get('type')=='Drive-thru' %}selected{% endif %}>Drive-thru
            </option>
            <option value="Other" {% if request.args.get('type')=='Other' %}selected{% endif %}>Other</option>
        </select>

        <!-- Filter: Position -->
        <select name="position" class="form-select filter-select"
            onchange="document.getElementById('filterForm').submit()" style="width: 140px;">
            <option value="">All Positions</option>
            <option value="Intermediate" {% if request.args.get('position')=='Intermediate' %}selected{% endif %}>
                Intermediate</option>
            <option value="Corner" {% if request.args.get('position')=='Corner' %}selected{% endif %}>Corner</option>
            <option value="End Lot" {% if request.args.get('position')=='End Lot' %}selected{% endif %}>End Lot</option>
        </select>

        <!-- Project Filter (Moved before Floor for logical flow) -->
        <select id="projectFilter" name="project" onchange="document.getElementById('filterForm').submit()"
            class="form-select filter-select" style="width: 160px;">
            <option value="">All Projects</option>
            {% for p in projects %}
            <option value="{{ p.name }}" {% if current_filters.project==p.name %}selected{% endif %}>{{ p.name }}
            </option>
            {% endfor %}
        </select>

        <!-- Filter: Floor -->
        <select id="floorFilter" name="floor" class="form-select filter-select"
            onchange="document.getElementById('filterForm').submit()" style="width: 100px;">
            <option value="">All Floors</option>
            <option value="G" {% if request.args.get('floor')=='G' %}selected{% endif %}>G</option>
            <option value="1" {% if request.args.get('floor')=='1' %}selected{% endif %}>1</option>
            <option value="2" {% if request.args.get('floor')=='2' %}selected{% endif %}>2</option>
            <option value="3" {% if request.args.get('floor')=='3' %}selected{% endif %}>3</option>
            <option value="4" {% if request.args.get('floor')=='4' %}selected{% endif %}>4</option>
        </select>

        <!-- Filter: Bedrooms -->
        <select id="bedroomsFilter" name="bedrooms" class="form-select filter-select"
            onchange="document.getElementById('filterForm').submit()" style="width: 120px; display: none;">
            <option value="">Bedrooms</option>
            <option value="0" {% if request.args.get('bedrooms')=='0' %}selected{% endif %}>Studio (0)</option>
            <option value="1" {% if request.args.get('bedrooms')=='1' %}selected{% endif %}>1 Room</option>
            <option value="2" {% if request.args.get('bedrooms')=='2' %}selected{% endif %}>2 Rooms</option>
            <option value="3" {% if request.args.get('bedrooms')=='3' %}selected{% endif %}>3 Rooms</option>
        </select>

        <!-- Filter: Furnishing -->
        <select name="furnishing" class="form-select filter-select"
            onchange="document.getElementById('filterForm').submit()" style="width: 140px;">
            <option value="">All Furnishing</option>
            <option value="Unfurnished" {% if request.args.get('furnishing')=='Unfurnished' %}selected{% endif %}>
                Unfurnished</option>
            <option value="Partially Furnished" {% if request.args.get('furnishing')=='Partially Furnished' %}selected{%
                endif %}>
                Partially</option>
            <option value="Fully Furnished" {% if request.args.get('furnishing')=='Fully Furnished' %}selected{% endif
                %}>
                Fully Furnished</option>
        </select>

        <!-- Search -->
        <div style="position: relative;">
            <i class='bx bx-search' style="position: absolute; left: 10px; top: 10px; color: var(--text-muted);"></i>
            <input type="text" name="search" id="propertySearchInput" placeholder="Search Unit/Project/Tenant..."
                value="{{ current_filters.search or '' }}"
                onkeydown="if(event.key === 'Enter'){event.preventDefault();}"
                style="padding: 8px 8px 8px 32px; border-radius: 6px; border: 1px solid var(--glass-border); background: var(--bg-card); color: var(--text-main); width: 250px;">
        </div>

        <!-- Status Filter (as pills) -->
        <div style="display: flex; gap: 5px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px;">
            <button type="submit" name="status" value=""
                class="btn-sm filter-pill {{ 'active' if not current_filters.status }}">
                All
            </button>
            <button type="submit" name="status" value="vacant"
                class="btn-sm filter-pill {{ 'active-vacant' if current_filters.status == 'vacant' }}">
                Vacant
            </button>
            <button type="submit" name="status" value="occupied"
                class="btn-sm filter-pill {{ 'active-occupied' if current_filters.status == 'occupied' }}">
                Occupied
            </button>
        </div>

        <!-- Show Archived Toggle -->
        <button type="submit" name="show_archived" value="{{ 'false' if current_filters.show_archived else 'true' }}"
            class="btn-sm toggle-btn {{ 'active' if current_filters.show_archived }}">
            <i class='bx bx-archive'></i> {{ 'Hide' if current_filters.show_archived else 'Show' }} Archived
        </button>

    </form>
</div>

<script>
    function handleProjectChange() {
        // Clear dependent filters if switching away from Elemen P2
        const projectSelect = document.getElementById('projectFilter');
        const bedroomsSelect = document.getElementById('bedroomsFilter');
        const floorSelect = document.getElementById('floorFilter');
        const isElemenP2 = projectSelect.value === 'Elemen P2';

        if (!isElemenP2) {
            bedroomsSelect.value = "";
            // Keep Floor if it is G-4? Or just reset to safe default?
            // Safer to reset if it was >4.
            const currentFloor = parseInt(floorSelect.value);
            if (currentFloor > 4) {
                floorSelect.value = "";
            }
        }

        // Submit the form
        projectSelect.form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const projectSelect = document.getElementById('projectFilter');
        const bedroomsSelect = document.getElementById('bedroomsFilter');
        const floorSelect = document.getElementById('floorFilter');

        // Base options for Floor (G-4)
        const baseFloorOptions = [
            { val: '', text: 'All Floors' },
            { val: 'G', text: 'G' },
            { val: '1', text: '1' },
            { val: '2', text: '2' },
            { val: '3', text: '3' },
            { val: '4', text: '4' }
        ];

        function updateUI() {
            const project = projectSelect.value;
            const isElemenP2 = project === 'Elemen P2';

            // Toggle Bedrooms
            if (isElemenP2) {
                bedroomsSelect.style.display = 'inline-block';
            } else {
                bedroomsSelect.style.display = 'none';
            }

            // Logic for Floor Options
            const currentFloor = floorSelect.getAttribute('data-server-value') || floorSelect.value;
            floorSelect.innerHTML = '';

            baseFloorOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.val;
                option.text = opt.text;
                if (opt.val === currentFloor) option.selected = true;
                floorSelect.appendChild(option);
            });

            if (isElemenP2) {
                // Add extended options (5-25)
                for (let i = 5; i <= 25; i++) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.text = i.toString();
                    if (i.toString() === currentFloor) option.selected = true;
                    floorSelect.appendChild(option);
                }
            }
        }

        // Store server-side value
        floorSelect.setAttribute('data-server-value', "{{ request.args.get('floor') or '' }}");

        // Initial Run
        updateUI();
    });
</script>



<!-- Bulk Delete Controls -->
<div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 15px; align-items: center;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-main);">
            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()"
                style="width: 18px; height: 18px; cursor: pointer;">
            <span>Select All</span>
        </label>
        <span id="selectedCount" style="color: var(--text-muted); font-size: 0.9rem;">0 selected</span>
    </div>
    <button id="deleteSelectedBtn" onclick="deleteSelected()" class="btn"
        style="background: linear-gradient(135deg, #ef4444, #dc2626); border: none; display: none;">
        <i class='bx bx-trash'></i> Delete Selected
    </button>
</div>

<!-- Property Groups -->
<div style="display: flex; flex-direction: column; gap: 40px;">
    {% if not property_groups %}
    <!-- Empty State -->
    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
        <i class='bx bx-search-alt' style="font-size: 4rem; opacity: 0.5; margin-bottom: 20px;"></i>
        <h3 style="color: var(--text-main); margin-bottom: 10px;">No properties found</h3>
        <p>Try adjusting your filters or search terms.</p>
        <button
            onclick="document.querySelector('form').reset(); window.location.href='{{ url_for('properties.dashboard') }}';"
            class="btn btn-primary" style="margin-top: 20px;">
            Clear All Filters
        </button>
    </div>
    {% else %}

    {% for project_name, items, stats in property_groups %}
    <div class="project-group">
        <div
            style="margin-bottom: 20px; border-bottom: 2px solid var(--glass-border); padding-bottom: 10px; display: flex; align-items: center; gap: 15px;">
            <h2 style="color: var(--text-main); margin: 0;">
                {{ project_name if project_name else 'Unassigned' }}
            </h2>

            <!-- Project Stats Pill -->
            <div
                style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 4px 12px; border-radius: 20px;">
                <span style="font-size: 0.9rem; color: var(--text-muted);">
                    {{ stats.occupied }} / {{ stats.total }} Occupied
                </span>

                <!-- Circular or Text Badge for Rate -->
                <span
                    style="font-size: 0.9rem; font-weight: bold; color: {{ '#34d399' if stats.rate > 80 else '#fbbf24' if stats.rate > 50 else '#f87171' }}">
                    {{ "%.0f"|format(stats.rate) }}%
                </span>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            {% for prop in items %}
            <!-- Logic for Individual Property Card -->
            {% set current_lease = prop.leases|selectattr("is_active", "equalto", true)|first %}
            {% if current_lease %}
            <div class="glass-card property-card {{ 'border-status-archived' if prop.archived else 'border-status-occupied' }}"
                style="padding: 20px; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;"
                data-search-content="{{ prop.unit_number.lower() }} {{ current_lease.tenant.name.lower() }} {{ project_name.lower() if project_name else 'unassigned' }}">

                <!-- Card Header -->
                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="checkbox" class="property-checkbox" value="{{ prop.id }}"
                            onchange="updateSelection()" style="width: 18px; height: 18px; cursor: pointer;">
                        <h3 style="font-size: 1.2rem; margin: 0;">{{ prop.unit_number }}</h3>
                    </div>
                    <span class="pill-status {{ 'pill-status-archived' if prop.archived else 'pill-status-occupied' }}">
                        {{ 'Archived' if prop.archived else 'Occupied' }}
                    </span>
                </div>

                <a href="{{ url_for('tenants.edit_tenant', id=current_lease.tenant.id) }}"
                    style="text-decoration: none; color: inherit; flex-grow: 1;">

                    <!-- Image -->
                    {% if prop.image_path %}
                    <div
                        style="width: 100%; height: 120px; background-image: url('{{ url_for('static', filename=prop.image_path) }}'); background-size: cover; background-position: center; border-radius: 6px; margin-bottom: 10px;">
                    </div>
                    {% endif %}

                    <div style="margin-bottom: 10px;">
                        <p style="font-size: 0.95rem; color: var(--text-main); font-weight: 500; margin-bottom: 5px;">{{
                            current_lease.tenant.name }}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <p style="font-size: 0.8rem; color: var(--text-muted);">Exp: {{
                                current_lease.end_date.strftime('%d %b %Y') }}</p>
                            <p style="font-size: 0.9rem; color: var(--success); font-weight: bold;">RM {{
                                "%.2f"|format(prop.target_rent) }}</p>
                        </div>
                    </div>
                </a>

                <!-- Action Footer -->
                <div
                    style="margin-top: auto; padding-top: 15px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <div></div> <!-- Spacer -->

                    <!-- Icons (Right) -->
                    <div style="display: flex; gap: 10px;">
                        <a href="{{ url_for('properties.history', id=prop.id) }}" class="btn-icon" title="View History"
                            style="color: var(--primary); font-size: 1.2rem; padding: 5px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
                            <i class='bx bx-history'></i>
                        </a>
                        <a href="{{ url_for('properties.edit_property', id=prop.id) }}" class="btn-icon"
                            title="Edit Property"
                            style="color: var(--text-main); font-size: 1.2rem; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <i class='bx bxs-edit'></i>
                        </a>
                        <button class="btn-icon"
                            style="color: var(--error); font-size: 1.2rem; padding: 5px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;"
                            title="Archive Property" onclick="archiveProperty('{{ prop.id }}', '{{prop.unit_number}}')">
                            <i class='bx bx-archive'></i>
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Vacant or No Lease -->
            <div class="glass-card property-card border-status-{{ 'archived' if prop.archived else prop.status|lower|replace(' ', '-') }}"
                style="padding: 20px; display: flex; flex-direction: column; height: 100%; transition: transform 0.2s;"
                data-search-content="{{ prop.unit_number.lower() }} {{ project_name.lower() if project_name else 'unassigned' }}">

                <!-- Card Header -->
                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="checkbox" class="property-checkbox" value="{{ prop.id }}"
                            onchange="updateSelection()" style="width: 18px; height: 18px; cursor: pointer;">
                        <h3 style="font-size: 1.2rem; margin: 0;">{{ prop.unit_number }}</h3>
                    </div>
                    <span
                        class="pill-status pill-status-{{ 'archived' if prop.archived else prop.status|lower|replace(' ', '-') }}">
                        {{ 'Archived' if prop.archived else prop.status|title }}
                    </span>
                </div>

                <a href="{{ url_for('tenants.add_tenant', unit=prop.unit_number) if not prop.archived else '#' }}"
                    style="text-decoration: none; color: inherit; flex-grow: 1; {{ 'pointer-events: none; opacity: 0.6;' if prop.archived else '' }}">

                    <!-- Image -->
                    {% if prop.image_path %}
                    <div
                        style="width: 100%; height: 120px; background-image: url('{{ url_for('static', filename=prop.image_path) }}'); background-size: cover; background-position: center; border-radius: 6px; margin-bottom: 10px;">
                    </div>
                    {% endif %}

                    {% if not prop.archived %}
                    <div style="margin-bottom: 15px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 1rem; color: var(--text-main); font-weight: bold;">RM {{
                                "%.2f"|format(prop.target_rent) }}</span>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);">{{ prop.size_sqft or '-' }}
                                    sqft</div>
                                {% if prop.land_size %}
                                <div style="font-size: 0.8rem; color: var(--text-muted);">Land: {{ prop.land_size }}
                                    sqft</div>
                                {% endif %}
                                {% if prop.furnishing_status %}
                                <div style="font-size: 0.7rem; margin-top: 2px;
                                    color: {{ '#10b981' if prop.furnishing_status == 'Fully Furnished' else 
                                              '#fbbf24' if prop.furnishing_status == 'Partially Furnished' else 
                                              'var(--text-muted)' }};">
                                    <i class='bx bx-chair'></i> {{ prop.furnishing_status }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div style="padding: 15px; text-align: center; color: var(--text-muted); font-style: italic;">
                        Property Archived
                    </div>
                    {% endif %}
                </a>

                <!-- Footer Actions -->
                <div
                    style="margin-top: auto; padding-top: 15px; border-top: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <!-- Rent Out Button (Left) -->
                    {% if not prop.archived %}
                    <a href="{{ url_for('tenants.add_tenant', unit=prop.unit_number) }}" class="btn btn-primary"
                        style="padding: 6px 15px; font-size: 0.9rem; text-decoration: none;">
                        <i class='bx bx-plus'></i> Rent Out
                    </a>
                    {% else %}
                    <div></div> <!-- Spacer -->
                    {% endif %}

                    <!-- Icons (Right) -->
                    <div style="display: flex; gap: 10px;">
                        <a href="{{ url_for('properties.history', id=prop.id) }}" class="btn-icon" title="View History"
                            style="color: var(--primary); font-size: 1.2rem; padding: 5px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
                            <i class='bx bx-history'></i>
                        </a>
                        <a href="{{ url_for('properties.edit_property', id=prop.id, **request.args.to_dict()) }}"
                            class="btn-icon" title="Edit Property"
                            style="color: var(--text-main); font-size: 1.2rem; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <i class='bx bxs-edit'></i>
                        </a>

                        {% if not prop.archived %}
                        <button class="btn-icon"
                            style="color: var(--error); font-size: 1.2rem; padding: 5px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;"
                            title="Archive Property" onclick="archiveProperty('{{ prop.id }}', '{{prop.unit_number}}')">
                            <i class='bx bx-archive'></i>
                        </button>
                        {% else %}
                        <button class="btn-icon"
                            style="color: var(--success); font-size: 1.2rem; padding: 5px; background: rgba(16, 185, 129, 0.1); border-radius: 4px;"
                            title="Restore Property"
                            onclick="unarchiveProperty('{{ prop.id }}', '{{prop.unit_number}}')">
                            <i class='bx bx-archive-out'></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<script>
    async function archiveProperty(id, unitNumber) {
        if (!confirm(`Archive property ${unitNumber}? It will be hidden from the main list.`)) return;

        try {
            const res = await fetch(`/properties/archive/${id}`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'Error archiving property');
            }
        } catch (e) {
            console.error(e);
            alert('An error occurred');
        }
    }

    async function unarchiveProperty(id, unitNumber) {
        if (!confirm(`Restore property ${unitNumber}?`)) return;

        try {
            const res = await fetch(`/properties/unarchive/${id}`, {
                method: 'POST'
            });
            const data = await res.json();

            if (data.status === 'success') {
                location.reload();
            } else {
                alert(data.message || 'Error restoring property');
            }
        } catch (e) {
            console.error(e);
            alert('An error occurred');
        }
    }

    // Bulk Delete Functions
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const checkboxes = document.querySelectorAll('.property-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
        updateSelection();
    }

    function updateSelection() {
        const checkboxes = document.querySelectorAll('.property-checkbox');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const count = checked.length;

        // Update counter
        document.getElementById('selectedCount').textContent = count + ' selected';

        // Show/hide delete button
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        deleteBtn.style.display = count > 0 ? 'block' : 'none';

        // Update select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        selectAllCheckbox.checked = count > 0 && count === checkboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < checkboxes.length;
    }

    // Client-Side Search
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('propertySearchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function (e) {
                const term = e.target.value.toLowerCase();
                filterPropertiesClientSide(term);
            });
        }
    });

    function filterPropertiesClientSide(term) {
        const groups = document.querySelectorAll('.project-group');

        // Safe term handling
        term = term ? term.toLowerCase().trim() : '';

        // Optimization: If empty, reset everything
        if (!term) {
            groups.forEach(group => {
                group.style.display = '';
                const cards = group.querySelectorAll('.property-card');
                cards.forEach(card => card.style.display = '');
            });
            return;
        }

        groups.forEach(group => {
            const cards = group.querySelectorAll('.property-card');
            let visibleInGroup = 0;

            cards.forEach(card => {
                const content = (card.getAttribute('data-search-content') || '').toLowerCase();

                if (content.includes(term)) {
                    card.style.display = ''; // Show
                    visibleInGroup++;
                } else {
                    card.style.display = 'none'; // Hide
                }
            });

            // Toggle Group Visibility
            if (visibleInGroup > 0) {
                group.style.display = '';
            } else {
                group.style.display = 'none';
            }
        });
    }

    function deleteSelected() {
        const btn = document.getElementById('deleteSelectedBtn');
        const checkboxes = document.querySelectorAll('.property-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);

        if (ids.length === 0) {
            alert('No properties selected');
            return;
        }

        // Check for 2-step confirmation
        if (btn.getAttribute('data-confirm') === 'true') {
            // EXECUTE DELETE
            const originalContent = btn.innerHTML;
            btn.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Deleting...";
            btn.disabled = true;

            fetch('/properties/bulk_delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ property_ids: ids })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`âœ“ Successfully deleted ${data.deleted_count} propert${data.deleted_count > 1 ? 'ies' : 'y'}`);
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                        resetDeleteBtn(btn, originalContent);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('An error occurred while deleting properties');
                    resetDeleteBtn(btn, originalContent);
                });
        } else {
            // FIRST CLICK - ENTER CONFIRM STATE
            btn.setAttribute('data-confirm', 'true');
            const originalText = btn.innerHTML; // Save icon+text

            // Allow storing original text to restore later if ignored
            if (!btn.hasAttribute('data-original-text')) {
                btn.setAttribute('data-original-text', originalText);
            }

            const noun = ids.length > 1 ? 'Props' : 'Prop';
            btn.innerHTML = `<i class='bx bx-check-double'></i> Confirm (${ids.length} ${noun})?`;
            btn.style.background = '#b91c1c'; // Darker/Danger Red

            // Auto-reset after 3 seconds if not clicked again
            setTimeout(() => {
                if (btn.getAttribute('data-confirm') === 'true' && !btn.disabled) {
                    const savedText = btn.getAttribute('data-original-text') || "<i class='bx bx-trash'></i> Delete Selected";
                    resetDeleteBtn(btn, savedText);
                }
            }, 3000);
        }
    }

    function resetDeleteBtn(btn, content) {
        btn.innerHTML = content;
        btn.disabled = false;
        btn.removeAttribute('data-confirm');
        btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
    }
</script>

<!-- Include Quick Add Tenant Modal -->


{% endblock %}